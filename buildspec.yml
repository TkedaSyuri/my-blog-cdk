version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - npm install -g aws-cdk
      - npm ci

  build:
    commands:
      # 差分チェック
      - echo "Checking for CDK diff..."
      - cdk diff > diff.log || true

      # デプロイするか判定（差分が含まれるか？）
      - |
        if grep -q 'Stack' diff.log; then
          echo "Changes detected. Deploying..."
          cdk deploy --require-approval never
        else
          echo "No changes detected. Skipping deploy."
        fi
